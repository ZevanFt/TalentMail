# TalentMail å®Œæ•´è‡ªåŠ¨åŒ–ç³»ç»Ÿè®¾è®¡æ–¹æ¡ˆ

> æœ¬æ–‡æ¡£æ•´åˆæ‰€æœ‰è‡ªåŠ¨åŒ–ç›¸å…³è®¾è®¡ï¼Œæä¾›ä¸€ä¸ªå®Œæ•´ã€å¯è½åœ°çš„å®ç°æ–¹æ¡ˆ

---

## ä¸€ã€æ ¸å¿ƒé—®é¢˜æ¢³ç†

### 1.1 å½“å‰ç³»ç»Ÿçš„é—®é¢˜

| é—®é¢˜ | ç°çŠ¶ | ç›®æ ‡ |
|-----|------|------|
| æ¨¡æ¿å®šä¹‰ | âœ… æœ‰ | - |
| æ¨¡æ¿ç¼–è¾‘ | âœ… æœ‰ | - |
| è§¦å‘æ¡ä»¶è®¾ç½® | âŒ æ²¡æœ‰ | å¯è§†åŒ–è®¾ç½®è§¦å‘æ¡ä»¶ |
| ä»€ä¹ˆæƒ…å†µè§¦å‘ | âŒ ä¸æ¸…æ¥š | æ˜ç¡®çš„äº‹ä»¶åˆ—è¡¨ |
| è°èƒ½è§¦å‘ | âŒ æ²¡æœ‰ | ç³»ç»Ÿè‡ªåŠ¨ / ç”¨æˆ·æ‰‹åŠ¨ |
| éå¼€å‘äººå‘˜ä½¿ç”¨ | âŒ å›°éš¾ | ç®€å•æ˜“ç”¨ |
| è‡ªåŠ¨åŒ–è§„åˆ™ | âœ… æœ‰å¼•æ“ | ä¸æ¨¡æ¿æ‰“é€š |

### 1.2 ç”¨æˆ·åœºæ™¯ç¤ºä¾‹

**åœºæ™¯ä¸€ï¼šè´¢åŠ¡å‘ç¥¨é€šçŸ¥**
> è´¢åŠ¡äººå‘˜å¼€å®Œå‘ç¥¨åï¼Œæƒ³ç”¨é¢„è®¾æ¨¡æ¿å‘é‚®ä»¶é€šçŸ¥å®¢æˆ·

**åœºæ™¯äºŒï¼šæ–°ç”¨æˆ·æ¬¢è¿**
> ç”¨æˆ·æ³¨å†ŒæˆåŠŸåï¼Œç³»ç»Ÿè‡ªåŠ¨å‘é€æ¬¢è¿é‚®ä»¶

**åœºæ™¯ä¸‰ï¼šå¼‚åœ°ç™»å½•æé†’**
> æ£€æµ‹åˆ°æ–°è®¾å¤‡ç™»å½•ï¼Œè‡ªåŠ¨å‘é€å®‰å…¨æé†’åˆ°ç”¨æˆ·é‚®ç®±

---

## äºŒã€æ•´ä½“æ¶æ„è®¾è®¡

### 2.1 ç³»ç»Ÿæ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           TalentMail è‡ªåŠ¨åŒ–ç³»ç»Ÿ                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚                           ğŸ“§ é‚®ä»¶æ¨¡æ¿å±‚                                â”‚  â”‚
â”‚  â”‚                                                                       â”‚  â”‚
â”‚  â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚
â”‚  â”‚   â”‚ ç³»ç»Ÿæ¨¡æ¿    â”‚  â”‚ ä¸šåŠ¡æ¨¡æ¿    â”‚  â”‚ è¥é”€æ¨¡æ¿    â”‚  â”‚ è‡ªå®šä¹‰æ¨¡æ¿  â”‚  â”‚  â”‚
â”‚  â”‚   â”‚ (éªŒè¯ç ç­‰) â”‚  â”‚ (è´¢åŠ¡/HR)  â”‚  â”‚ (ä¿ƒé”€é€šçŸ¥) â”‚  â”‚ (ç”¨æˆ·åˆ›å»º) â”‚  â”‚  â”‚
â”‚  â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                    â”‚                                        â”‚
â”‚                                    â–¼                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚                           âš¡ è§¦å‘å™¨å±‚                                  â”‚  â”‚
â”‚  â”‚                                                                       â”‚  â”‚
â”‚  â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚
â”‚  â”‚   â”‚ ç³»ç»Ÿäº‹ä»¶    â”‚  â”‚ å®šæ—¶ä»»åŠ¡    â”‚  â”‚ æ‰‹åŠ¨è§¦å‘    â”‚  â”‚ Webhook     â”‚  â”‚  â”‚
â”‚  â”‚   â”‚ (æ³¨å†Œ/ç™»å½•)â”‚  â”‚ (æ¯å¤©æ£€æŸ¥) â”‚  â”‚ (ç”¨æˆ·æ“ä½œ) â”‚  â”‚ (å¤–éƒ¨è°ƒç”¨) â”‚  â”‚  â”‚
â”‚  â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                    â”‚                                        â”‚
â”‚                                    â–¼                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚                           ğŸ”§ æ‰§è¡Œå¼•æ“å±‚                                â”‚  â”‚
â”‚  â”‚                                                                       â”‚  â”‚
â”‚  â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚  â”‚
â”‚  â”‚   â”‚ æ¨¡æ¿è§¦å‘å™¨           â”‚     â”‚ è§„åˆ™å¼•æ“              â”‚              â”‚  â”‚
â”‚  â”‚   â”‚ (TemplateTrigger)   â”‚     â”‚ (RuleEngine)         â”‚              â”‚  â”‚
â”‚  â”‚   â”‚                      â”‚     â”‚                      â”‚              â”‚  â”‚
â”‚  â”‚   â”‚ - ç®€å•ï¼šäº‹ä»¶â†’æ¨¡æ¿    â”‚     â”‚ - å¤æ‚ï¼šæ¡ä»¶â†’åŠ¨ä½œ    â”‚              â”‚  â”‚
â”‚  â”‚   â”‚ - æ— éœ€ç¼–ç¨‹           â”‚     â”‚ - å¯ç¼–ç¨‹             â”‚              â”‚  â”‚
â”‚  â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.2 æ ¸å¿ƒæ¦‚å¿µ

| æ¦‚å¿µ | è¯´æ˜ | ç¤ºä¾‹ |
|-----|------|------|
| **æ¨¡æ¿** | é‚®ä»¶å†…å®¹æ¨¡æ¿ | æ¬¢è¿é‚®ä»¶ã€éªŒè¯ç é‚®ä»¶ |
| **è§¦å‘å™¨** | ä»€ä¹ˆæ—¶å€™å‘é€ | ç”¨æˆ·æ³¨å†Œæ—¶ã€æ¯å¤©9ç‚¹ |
| **æ¡ä»¶** | æ»¡è¶³ä»€ä¹ˆæ¡ä»¶æ‰å‘é€ | å­˜å‚¨ä½¿ç”¨>80% |
| **åŠ¨ä½œ** | å‘é€ç»™è° | ç”¨æˆ·æœ¬äººã€ç®¡ç†å‘˜ |

---

## ä¸‰ã€è§¦å‘å™¨ç±»å‹å®šä¹‰

### 3.1 ç³»ç»Ÿäº‹ä»¶è§¦å‘å™¨

è¿™äº›æ˜¯ç³»ç»Ÿå†…ç½®çš„äº‹ä»¶ï¼Œåœ¨ç‰¹å®šæ“ä½œæ—¶è‡ªåŠ¨è§¦å‘ï¼š

```python
SYSTEM_EVENTS = {
    # ============ ç”¨æˆ·äº‹ä»¶ ============
    "user.register_success": {
        "name": "ç”¨æˆ·æ³¨å†ŒæˆåŠŸ",
        "description": "ç”¨æˆ·å®Œæˆæ³¨å†Œåè§¦å‘",
        "available_variables": ["user_name", "user_email", "register_time"],
        "category": "user"
    },
    "user.login_new_device": {
        "name": "æ–°è®¾å¤‡ç™»å½•",
        "description": "æ£€æµ‹åˆ°ç”¨æˆ·ä»æ–°è®¾å¤‡æˆ–æ–°IPç™»å½•æ—¶è§¦å‘",
        "available_variables": ["user_name", "login_time", "login_ip", "login_device", "login_location"],
        "category": "user"
    },
    "user.password_changed": {
        "name": "å¯†ç ä¿®æ”¹æˆåŠŸ",
        "description": "ç”¨æˆ·ä¿®æ”¹å¯†ç åè§¦å‘",
        "available_variables": ["user_name", "change_time"],
        "category": "user"
    },
    "user.storage_warning": {
        "name": "å­˜å‚¨ç©ºé—´è­¦å‘Š",
        "description": "ç”¨æˆ·å­˜å‚¨ä½¿ç”¨è¶…è¿‡é˜ˆå€¼æ—¶è§¦å‘",
        "available_variables": ["user_name", "used_percent", "used_space", "total_space"],
        "category": "user",
        "configurable": True,  # å¯é…ç½®é˜ˆå€¼
        "config_schema": {
            "threshold": {"type": "number", "default": 80, "label": "è­¦å‘Šé˜ˆå€¼(%)"}
        }
    },
    
    # ============ é‚®ä»¶äº‹ä»¶ ============
    "email.received": {
        "name": "æ”¶åˆ°æ–°é‚®ä»¶",
        "description": "æ”¶åˆ°æ–°é‚®ä»¶æ—¶è§¦å‘",
        "available_variables": ["sender_email", "sender_name", "subject", "received_time"],
        "category": "email"
    },
    "email.sent": {
        "name": "é‚®ä»¶å‘é€æˆåŠŸ",
        "description": "é‚®ä»¶å‘é€æˆåŠŸåè§¦å‘",
        "available_variables": ["recipient_email", "subject", "sent_time"],
        "category": "email"
    },
    
    # ============ æ–‡ä»¶äº‹ä»¶ ============
    "drive.file_shared": {
        "name": "æ–‡ä»¶è¢«åˆ†äº«",
        "description": "ç”¨æˆ·åˆ›å»ºæ–‡ä»¶åˆ†äº«é“¾æ¥æ—¶è§¦å‘",
        "available_variables": ["sender_name", "sender_email", "file_name", "file_size", "share_url", "expires_at"],
        "category": "drive"
    },
    
    # ============ ç®¡ç†äº‹ä»¶ ============
    "admin.invite_created": {
        "name": "åˆ›å»ºé‚€è¯·ç ",
        "description": "ç®¡ç†å‘˜åˆ›å»ºé‚€è¯·ç æ—¶è§¦å‘",
        "available_variables": ["inviter_name", "inviter_email", "invite_code", "invite_url", "expires_at"],
        "category": "admin"
    }
}
```

### 3.2 å®šæ—¶è§¦å‘å™¨

```python
SCHEDULE_TYPES = {
    "daily": {
        "name": "æ¯å¤©",
        "config_schema": {
            "time": {"type": "time", "label": "æ‰§è¡Œæ—¶é—´", "default": "09:00"}
        }
    },
    "weekly": {
        "name": "æ¯å‘¨",
        "config_schema": {
            "day": {"type": "select", "options": ["å‘¨ä¸€", "å‘¨äºŒ", "å‘¨ä¸‰", "å‘¨å››", "å‘¨äº”", "å‘¨å…­", "å‘¨æ—¥"]},
            "time": {"type": "time", "label": "æ‰§è¡Œæ—¶é—´", "default": "09:00"}
        }
    },
    "monthly": {
        "name": "æ¯æœˆ",
        "config_schema": {
            "day": {"type": "number", "min": 1, "max": 28, "label": "æ—¥æœŸ"},
            "time": {"type": "time", "label": "æ‰§è¡Œæ—¶é—´", "default": "09:00"}
        }
    },
    "interval": {
        "name": "é—´éš”æ‰§è¡Œ",
        "config_schema": {
            "value": {"type": "number", "label": "é—´éš”å€¼"},
            "unit": {"type": "select", "options": ["åˆ†é’Ÿ", "å°æ—¶", "å¤©"]}
        }
    }
}
```

### 3.3 æ‰‹åŠ¨è§¦å‘å™¨

ç”¨æˆ·åœ¨ç•Œé¢ä¸Šä¸»åŠ¨è§¦å‘ï¼š
- åœ¨ ComposeModal ä¸­é€‰æ‹©æ¨¡æ¿å‘é€
- ç‚¹å‡»"å‘é€æµ‹è¯•é‚®ä»¶"æŒ‰é’®

---

## å››ã€æ•°æ®åº“è®¾è®¡

### 4.1 æ¨¡æ¿è§¦å‘é…ç½®è¡¨

```sql
CREATE TABLE template_triggers (
    id SERIAL PRIMARY KEY,
    
    -- å…³è”æ¨¡æ¿
    template_code VARCHAR(50) NOT NULL REFERENCES system_email_templates(code),
    
    -- è§¦å‘å™¨é…ç½®
    trigger_type VARCHAR(30) NOT NULL,  -- system_event / scheduled / manual
    trigger_event VARCHAR(100),          -- äº‹ä»¶åç§°ï¼Œå¦‚ user.register_success
    trigger_config JSONB DEFAULT '{}',   -- è§¦å‘å™¨å‚æ•°é…ç½®
    
    -- æ¡ä»¶é…ç½®ï¼ˆå¯é€‰ï¼Œæ»¡è¶³æ¡ä»¶æ‰è§¦å‘ï¼‰
    conditions JSONB DEFAULT '[]',
    
    -- å‘é€é…ç½®
    send_to_type VARCHAR(20) NOT NULL DEFAULT 'trigger_user',  -- trigger_user / fixed_email / admin
    send_to_email VARCHAR(255),           -- å½“ send_to_type = fixed_email æ—¶ä½¿ç”¨
    
    -- çŠ¶æ€
    is_enabled BOOLEAN DEFAULT true,
    
    -- é˜²æ­¢é‡å¤å‘é€
    cooldown_hours INTEGER DEFAULT 0,     -- å†·å´æ—¶é—´ï¼ˆå°æ—¶ï¼‰ï¼Œ0è¡¨ç¤ºä¸é™åˆ¶
    last_triggered_at TIMESTAMP,
    
    -- ç»Ÿè®¡
    trigger_count INTEGER DEFAULT 0,
    
    -- å…ƒæ•°æ®
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW(),
    created_by INTEGER REFERENCES users(id)
);

-- ç´¢å¼•
CREATE INDEX idx_template_triggers_template ON template_triggers(template_code);
CREATE INDEX idx_template_triggers_event ON template_triggers(trigger_event);
CREATE INDEX idx_template_triggers_enabled ON template_triggers(is_enabled);
```

### 4.2 è§¦å‘æ—¥å¿—è¡¨

```sql
CREATE TABLE template_trigger_logs (
    id SERIAL PRIMARY KEY,
    
    trigger_id INTEGER REFERENCES template_triggers(id),
    template_code VARCHAR(50),
    
    -- è§¦å‘ä¿¡æ¯
    trigger_type VARCHAR(30),
    trigger_event VARCHAR(100),
    trigger_data JSONB,
    
    -- æ‰§è¡Œç»“æœ
    status VARCHAR(20),        -- success / failed / skipped
    recipient_email VARCHAR(255),
    error_message TEXT,
    
    -- æ—¶é—´
    triggered_at TIMESTAMP DEFAULT NOW(),
    execution_time_ms INTEGER
);

-- ç´¢å¼•
CREATE INDEX idx_trigger_logs_trigger ON template_trigger_logs(trigger_id);
CREATE INDEX idx_trigger_logs_time ON template_trigger_logs(triggered_at);
```

### 4.3 åˆå§‹åŒ–æ•°æ®

```python
# backend/initial/init_template_triggers.py

DEFAULT_TEMPLATE_TRIGGERS = [
    # ===== ç³»ç»Ÿè‡ªåŠ¨è§¦å‘çš„æ¨¡æ¿ =====
    {
        "template_code": "verification_code_register",
        "trigger_type": "system_event",
        "trigger_event": "user.send_verification_code",
        "trigger_config": {"purpose": "register"},
        "send_to_type": "trigger_user",
        "is_enabled": True
    },
    {
        "template_code": "verification_code_reset_password",
        "trigger_type": "system_event",
        "trigger_event": "user.send_verification_code",
        "trigger_config": {"purpose": "reset_password"},
        "send_to_type": "trigger_user",
        "is_enabled": True
    },
    {
        "template_code": "welcome_email",
        "trigger_type": "system_event",
        "trigger_event": "user.register_success",
        "send_to_type": "trigger_user",
        "is_enabled": True
    },
    {
        "template_code": "login_alert",
        "trigger_type": "system_event",
        "trigger_event": "user.login_new_device",
        "send_to_type": "trigger_user",  # å‘é€åˆ°ç”¨æˆ·çš„æ¢å¤é‚®ç®±
        "is_enabled": True
    },
    {
        "template_code": "storage_warning",
        "trigger_type": "scheduled",
        "trigger_config": {"schedule": "daily", "time": "09:00"},
        "conditions": [
            {"field": "storage_used_percent", "operator": "greater_than", "value": 80}
        ],
        "send_to_type": "trigger_user",
        "cooldown_hours": 24,  # 24å°æ—¶å†…ä¸é‡å¤å‘é€
        "is_enabled": True
    },
    {
        "template_code": "file_share_notification",
        "trigger_type": "system_event",
        "trigger_event": "drive.file_shared",
        "send_to_type": "fixed_email",  # å‘é€ç»™åˆ†äº«æ¥æ”¶è€…
        "is_enabled": True
    },
    {
        "template_code": "invite_registration",
        "trigger_type": "manual",  # æ‰‹åŠ¨è§¦å‘
        "is_enabled": True
    }
]
```

---

## äº”ã€å‰ç«¯ç•Œé¢è®¾è®¡

### 5.1 æ¨¡æ¿ç®¡ç†é¡µé¢æ”¹é€ 

åœ¨ç°æœ‰æ¨¡æ¿åˆ—è¡¨ä¸­å¢åŠ "è§¦å‘è®¾ç½®"åŠŸèƒ½ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ é‚®ä»¶æ¨¡æ¿ç®¡ç†                                              [å…¨å±€å˜é‡] [æ–°å»º] â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ [å…¨éƒ¨åˆ†ç±» â–¼]  [å…¨éƒ¨çŠ¶æ€ â–¼]                                                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                             â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ âœ… æ¬¢è¿æ–°ç”¨æˆ·                                      [è®¤è¯ç›¸å…³] [ç³»ç»Ÿæ¨¡æ¿] â”‚ â”‚
â”‚ â”‚     welcome_email                                                       â”‚ â”‚
â”‚ â”‚     ç”¨æˆ·æ³¨å†ŒæˆåŠŸåå‘é€çš„æ¬¢è¿é‚®ä»¶                                         â”‚ â”‚
â”‚ â”‚                                                                         â”‚ â”‚
â”‚ â”‚     âš¡ è§¦å‘æ–¹å¼ï¼šç³»ç»Ÿäº‹ä»¶ - ç”¨æˆ·æ³¨å†ŒæˆåŠŸ                                 â”‚ â”‚
â”‚ â”‚     ğŸ“® å‘é€ç»™ï¼šè§¦å‘ç”¨æˆ·æœ¬äºº                                             â”‚ â”‚
â”‚ â”‚     ğŸ“Š å·²å‘é€ 128 æ¬¡                                                    â”‚ â”‚
â”‚ â”‚                                                                         â”‚ â”‚
â”‚ â”‚                                        [é¢„è§ˆ] [ç¼–è¾‘å†…å®¹] [âš™ï¸ è§¦å‘è®¾ç½®]   â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                             â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ âœ… å­˜å‚¨ç©ºé—´è­¦å‘Š                                    [ç³»ç»Ÿé€šçŸ¥] [ç³»ç»Ÿæ¨¡æ¿] â”‚ â”‚
â”‚ â”‚     storage_warning                                                     â”‚ â”‚
â”‚ â”‚     ç”¨æˆ·å­˜å‚¨ç©ºé—´å³å°†ç”¨å°½æ—¶å‘é€çš„è­¦å‘Š                                     â”‚ â”‚
â”‚ â”‚                                                                         â”‚ â”‚
â”‚ â”‚     âš¡ è§¦å‘æ–¹å¼ï¼šå®šæ—¶æ£€æŸ¥ - æ¯å¤© 09:00                                   â”‚ â”‚
â”‚ â”‚     ğŸ“‹ è§¦å‘æ¡ä»¶ï¼šå­˜å‚¨ä½¿ç”¨ > 80%                                         â”‚ â”‚
â”‚ â”‚     ğŸ“® å‘é€ç»™ï¼šè§¦å‘ç”¨æˆ·æœ¬äºº                                             â”‚ â”‚
â”‚ â”‚     ğŸ”„ å†·å´æ—¶é—´ï¼š24å°æ—¶                                                 â”‚ â”‚
â”‚ â”‚                                                                         â”‚ â”‚
â”‚ â”‚                                        [é¢„è§ˆ] [ç¼–è¾‘å†…å®¹] [âš™ï¸ è§¦å‘è®¾ç½®]   â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                             â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ âŒ å‘ç¥¨å¼€å…·é€šçŸ¥                                    [è´¢åŠ¡é€šçŸ¥] [ä¸šåŠ¡æ¨¡æ¿] â”‚ â”‚
â”‚ â”‚     invoice_notification                                                â”‚ â”‚
â”‚ â”‚     é€šçŸ¥å®¢æˆ·å‘ç¥¨å·²å¼€å…·                                                  â”‚ â”‚
â”‚ â”‚                                                                         â”‚ â”‚
â”‚ â”‚     âš¡ è§¦å‘æ–¹å¼ï¼šæ‰‹åŠ¨ä½¿ç”¨                                               â”‚ â”‚
â”‚ â”‚     ğŸ“® å‘é€ç»™ï¼šæ‰‹åŠ¨è¾“å…¥                                                 â”‚ â”‚
â”‚ â”‚     âš ï¸ æœªå¯ç”¨ - ç‚¹å‡»è®¾ç½®å¯ç”¨                                            â”‚ â”‚
â”‚ â”‚                                                                         â”‚ â”‚
â”‚ â”‚                                        [é¢„è§ˆ] [ç¼–è¾‘å†…å®¹] [âš™ï¸ è§¦å‘è®¾ç½®]   â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 5.2 è§¦å‘è®¾ç½®å¼¹çª—

ç‚¹å‡»"âš™ï¸ è§¦å‘è®¾ç½®"åæ˜¾ç¤ºï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ è§¦å‘è®¾ç½® - æ¬¢è¿æ–°ç”¨æˆ·                                                  [Ã—] â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                             â”‚
â”‚  å¯ç”¨çŠ¶æ€                                                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ [âœ… å¼€å…³]  å¯ç”¨æ­¤æ¨¡æ¿çš„è‡ªåŠ¨è§¦å‘                                      â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                             â”‚
â”‚  è§¦å‘æ–¹å¼                                                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ â— ç³»ç»Ÿäº‹ä»¶è§¦å‘                                                       â”‚   â”‚
â”‚  â”‚   å½“ç³»ç»Ÿå‘ç”Ÿç‰¹å®šäº‹ä»¶æ—¶è‡ªåŠ¨å‘é€é‚®ä»¶                                    â”‚   â”‚
â”‚  â”‚                                                                     â”‚   â”‚
â”‚  â”‚   é€‰æ‹©äº‹ä»¶ï¼š                                                         â”‚   â”‚
â”‚  â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚   â”‚
â”‚  â”‚   â”‚ ğŸ‘¤ ç”¨æˆ·äº‹ä»¶                                                  â”‚   â”‚   â”‚
â”‚  â”‚   â”‚   â— ç”¨æˆ·æ³¨å†ŒæˆåŠŸ                                            â† é€‰ä¸­ â”‚
â”‚  â”‚   â”‚   â—‹ æ–°è®¾å¤‡ç™»å½•                                               â”‚   â”‚   â”‚
â”‚  â”‚   â”‚   â—‹ å¯†ç ä¿®æ”¹æˆåŠŸ                                             â”‚   â”‚   â”‚
â”‚  â”‚   â”‚ ğŸ“§ é‚®ä»¶äº‹ä»¶                                                  â”‚   â”‚   â”‚
â”‚  â”‚   â”‚   â—‹ æ”¶åˆ°æ–°é‚®ä»¶                                               â”‚   â”‚   â”‚
â”‚  â”‚   â”‚   â—‹ é‚®ä»¶å‘é€æˆåŠŸ                                             â”‚   â”‚   â”‚
â”‚  â”‚   â”‚ ğŸ“ æ–‡ä»¶äº‹ä»¶                                                  â”‚   â”‚   â”‚
â”‚  â”‚   â”‚   â—‹ æ–‡ä»¶è¢«åˆ†äº«                                               â”‚   â”‚   â”‚
â”‚  â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚   â”‚
â”‚  â”‚                                                                     â”‚   â”‚
â”‚  â”‚ â—‹ å®šæ—¶è§¦å‘                                                          â”‚   â”‚
â”‚  â”‚   æŒ‰ç…§è®¾å®šçš„æ—¶é—´å‘¨æœŸè‡ªåŠ¨æ£€æŸ¥å¹¶å‘é€                                    â”‚   â”‚
â”‚  â”‚                                                                     â”‚   â”‚
â”‚  â”‚ â—‹ æ‰‹åŠ¨ä½¿ç”¨                                                          â”‚   â”‚
â”‚  â”‚   ç”¨æˆ·åœ¨æ’°å†™é‚®ä»¶æ—¶é€‰æ‹©æ­¤æ¨¡æ¿å‘é€                                      â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                             â”‚
â”‚  è§¦å‘æ¡ä»¶ï¼ˆå¯é€‰ï¼‰                                                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ æ»¡è¶³ä»¥ä¸‹æ‰€æœ‰æ¡ä»¶æ—¶æ‰è§¦å‘ï¼š                                           â”‚   â”‚
â”‚  â”‚                                                                     â”‚   â”‚
â”‚  â”‚ ï¼ˆå½“å‰äº‹ä»¶æ— éœ€é¢å¤–æ¡ä»¶ï¼‰                                              â”‚   â”‚
â”‚  â”‚                                                                     â”‚   â”‚
â”‚  â”‚ [+ æ·»åŠ æ¡ä»¶]                                                        â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                             â”‚
â”‚  å‘é€ç»™è°                                                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ â— è§¦å‘äº‹ä»¶çš„ç”¨æˆ·æœ¬äºº                                                 â”‚   â”‚
â”‚  â”‚   é‚®ä»¶å°†å‘é€åˆ°è§¦å‘æ­¤äº‹ä»¶çš„ç”¨æˆ·é‚®ç®±                                    â”‚   â”‚
â”‚  â”‚                                                                     â”‚   â”‚
â”‚  â”‚ â—‹ æŒ‡å®šé‚®ç®±                                                          â”‚   â”‚
â”‚  â”‚   [                                                          ]      â”‚   â”‚
â”‚  â”‚                                                                     â”‚   â”‚
â”‚  â”‚ â—‹ ç³»ç»Ÿç®¡ç†å‘˜                                                        â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                             â”‚
â”‚  é«˜çº§è®¾ç½®                                                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ â–¡ è®¾ç½®å†·å´æ—¶é—´ï¼ˆé¿å…é‡å¤å‘é€ï¼‰                                        â”‚   â”‚
â”‚  â”‚   å†·å´æ—¶é—´ï¼š[24] å°æ—¶                                                â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                             â”‚
â”‚  å¯ç”¨å˜é‡é¢„è§ˆ                                                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ æ­¤äº‹ä»¶è§¦å‘æ—¶ï¼Œä»¥ä¸‹å˜é‡å¯åœ¨æ¨¡æ¿ä¸­ä½¿ç”¨ï¼š                                 â”‚   â”‚
â”‚  â”‚                                                                     â”‚   â”‚
â”‚  â”‚ {{user_name}}     ç”¨æˆ·å                                            â”‚   â”‚
â”‚  â”‚ {{user_email}}    ç”¨æˆ·é‚®ç®±                                          â”‚   â”‚
â”‚  â”‚ {{register_time}} æ³¨å†Œæ—¶é—´                                          â”‚   â”‚
â”‚  â”‚ {{login_url}}     ç™»å½•é“¾æ¥ï¼ˆå…¨å±€å˜é‡ï¼‰                                â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                    [å–æ¶ˆ]    [ä¿å­˜è®¾ç½®]     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 5.3 å®šæ—¶è§¦å‘é…ç½®

å½“é€‰æ‹©"å®šæ—¶è§¦å‘"æ—¶ï¼š

```
â”‚  è§¦å‘æ–¹å¼                                                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ â— å®šæ—¶è§¦å‘                                                          â”‚   â”‚
â”‚  â”‚   æŒ‰ç…§è®¾å®šçš„æ—¶é—´å‘¨æœŸè‡ªåŠ¨æ£€æŸ¥å¹¶å‘é€                                    â”‚   â”‚
â”‚  â”‚                                                                     â”‚   â”‚
â”‚  â”‚   æ‰§è¡Œå‘¨æœŸï¼š                                                         â”‚   â”‚
â”‚  â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                            â”‚   â”‚
â”‚  â”‚   â”‚ â— æ¯å¤©   â—‹ æ¯å‘¨   â—‹ æ¯æœˆ   â—‹ é—´éš”  â”‚                            â”‚   â”‚
â”‚  â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                            â”‚   â”‚
â”‚  â”‚                                                                     â”‚   â”‚
â”‚  â”‚   æ‰§è¡Œæ—¶é—´ï¼š[09:00]                                                  â”‚   â”‚
â”‚  â”‚                                                                     â”‚   â”‚
â”‚  â”‚   æ£€æŸ¥èŒƒå›´ï¼š                                                         â”‚   â”‚
â”‚  â”‚   â— æ‰€æœ‰ç”¨æˆ·                                                        â”‚   â”‚
â”‚  â”‚   â—‹ æŒ‡å®šç”¨æˆ·ç»„                                                      â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
```

### 5.4 ComposeModal æ¨¡æ¿é€‰æ‹©

åœ¨æ’°å†™é‚®ä»¶æ—¶æ·»åŠ æ¨¡æ¿é€‰æ‹©åŠŸèƒ½ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æ–°é‚®ä»¶                                                                 [Ã—] â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                             â”‚
â”‚  [ğŸ“‹ ä½¿ç”¨æ¨¡æ¿ â–¼]                                                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ ğŸ“„ è´¢åŠ¡é€šçŸ¥                                                         â”‚   â”‚
â”‚  â”‚   â”œâ”€ ğŸ“§ å‘ç¥¨å¼€å…·é€šçŸ¥                                                â”‚   â”‚
â”‚  â”‚   â”œâ”€ ğŸ“§ ä»˜æ¬¾åˆ°è´¦é€šçŸ¥                                                â”‚   â”‚
â”‚  â”‚   â””â”€ ğŸ“§ æŠ¥é”€å®¡æ‰¹ç»“æœ                                                â”‚   â”‚
â”‚  â”‚                                                                     â”‚   â”‚
â”‚  â”‚ ğŸ‘¥ äººäº‹é€šçŸ¥                                                         â”‚   â”‚
â”‚  â”‚   â”œâ”€ ğŸ“§ æ–°å‘˜å·¥å…¥èŒæ¬¢è¿                                              â”‚   â”‚
â”‚  â”‚   â”œâ”€ ğŸ“§ å‡æœŸå®¡æ‰¹é€šçŸ¥                                                â”‚   â”‚
â”‚  â”‚   â””â”€ ğŸ“§ è€ƒå‹¤å¼‚å¸¸æé†’                                                â”‚   â”‚
â”‚  â”‚                                                                     â”‚   â”‚
â”‚  â”‚ ğŸ“¢ è¥é”€æ¨å¹¿                                                         â”‚   â”‚
â”‚  â”‚   â”œâ”€ ğŸ“§ æ–°å“å‘å¸ƒé€šçŸ¥                                                â”‚   â”‚
â”‚  â”‚   â””â”€ ğŸ“§ æ´»åŠ¨é‚€è¯·                                                    â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                             â”‚
â”‚  æ”¶ä»¶äºº: [customer@example.com                                    ] [æŠ„é€] â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
â”‚  ä¸»é¢˜:   [æ‚¨çš„å‘ç¥¨å·²å¼€å…· - {{invoice_number}}                          ]   â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
â”‚                                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ ğŸ“ å¡«å†™æ¨¡æ¿å˜é‡ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                               â”‚
â”‚  â”‚                                          â”‚                              â”‚
â”‚  â”‚  å®¢æˆ·åç§° *                              â”‚                              â”‚
â”‚  â”‚  [                                  ]    â”‚                              â”‚
â”‚  â”‚                                          â”‚                              â”‚
â”‚  â”‚  å‘ç¥¨å·ç  *                              â”‚                              â”‚
â”‚  â”‚  [                                  ]    â”‚                              â”‚
â”‚  â”‚                                          â”‚                              â”‚
â”‚  â”‚  å‘ç¥¨é‡‘é¢ *                              â”‚                              â”‚
â”‚  â”‚  [                                  ]    â”‚                              â”‚
â”‚  â”‚                                          â”‚                              â”‚
â”‚  â”‚              [é¢„è§ˆæ•ˆæœ]                   â”‚                              â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                              â”‚
â”‚                                                                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  [ğŸ“ é™„ä»¶]                                                        [å‘é€ âœˆ] â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## å…­ã€åç«¯å®ç°

### 6.1 äº‹ä»¶å‘å¸ƒå™¨

```python
# backend/core/events.py

from typing import Dict, Any, Optional, List
from sqlalchemy.orm import Session
from datetime import datetime, timedelta
import logging

logger = logging.getLogger(__name__)

class EventPublisher:
    """ç»Ÿä¸€äº‹ä»¶å‘å¸ƒå™¨"""
    
    def __init__(self, db: Session):
        self.db = db
    
    async def publish(
        self, 
        event_type: str, 
        data: Dict[str, Any], 
        user_id: Optional[int] = None
    ):
        """
        å‘å¸ƒäº‹ä»¶
        
        Args:
            event_type: äº‹ä»¶ç±»å‹ï¼Œå¦‚ "user.register_success"
            data: äº‹ä»¶æ•°æ®ï¼ˆå°†ä½œä¸ºæ¨¡æ¿å˜é‡ï¼‰
            user_id: ç›¸å…³ç”¨æˆ·ID
        """
        logger.info(f"Event published: {event_type}")
        
        # æŸ¥æ‰¾åŒ¹é…çš„æ¨¡æ¿è§¦å‘å™¨
        triggers = self._get_matching_triggers(event_type)
        
        for trigger in triggers:
            await self._execute_trigger(trigger, data, user_id)
    
    def _get_matching_triggers(self, event_type: str) -> List:
        """è·å–åŒ¹é…çš„è§¦å‘å™¨"""
        from db.models.template import TemplateTrigger
        
        return self.db.query(TemplateTrigger).filter(
            TemplateTrigger.trigger_type == "system_event",
            TemplateTrigger.trigger_event == event_type,
            TemplateTrigger.is_enabled == True
        ).all()
    
    async def _execute_trigger(
        self, 
        trigger, 
        data: Dict[str, Any], 
        user_id: Optional[int]
    ):
        """æ‰§è¡Œè§¦å‘å™¨"""
        from db.models.template import TemplateTriggerLog
        from core.mail_service import MailService
        
        # æ£€æŸ¥å†·å´æ—¶é—´
        if trigger.cooldown_hours > 0 and trigger.last_triggered_at:
            cooldown_until = trigger.last_triggered_at + timedelta(hours=trigger.cooldown_hours)
            if datetime.utcnow() < cooldown_until:
                logger.info(f"Trigger {trigger.id} is in cooldown")
                return
        
        # æ£€æŸ¥æ¡ä»¶
        if trigger.conditions and not self._check_conditions(trigger.conditions, data):
            logger.info(f"Trigger {trigger.id} conditions not met")
            return
        
        # ç¡®å®šæ”¶ä»¶äºº
        to_email = self._resolve_recipient(trigger, data, user_id)
        if not to_email:
            logger.warning(f"Cannot resolve recipient for trigger {trigger.id}")
            return
        
        # åˆ›å»ºæ—¥å¿—
        log = TemplateTriggerLog(
            trigger_id=trigger.id,
            template_code=trigger.template_code,
            trigger_type=trigger.trigger_type,
            trigger_event=trigger.trigger_event,
            trigger_data=data,
            recipient_email=to_email,
            triggered_at=datetime.utcnow()
        )
        
        try:
            # å‘é€é‚®ä»¶
            mail_service = MailService(self.db)
            success = await mail_service.send_template_email_async(
                template_code=trigger.template_code,
                to_email=to_email,
                context=data
            )
            
            log.status = "success" if success else "failed"
            
            # æ›´æ–°è§¦å‘å™¨ç»Ÿè®¡
            trigger.trigger_count = (trigger.trigger_count or 0) + 1
            trigger.last_triggered_at = datetime.utcnow()
            
        except Exception as e:
            log.status = "failed"
            log.error_message = str(e)
            logger.error(f"Trigger execution failed: {e}")
        
        self.db.add(log)
        self.db.commit()
    
    def _check_conditions(self, conditions: List[Dict], data: Dict) -> bool:
        """æ£€æŸ¥æ¡ä»¶"""
        for condition in conditions:
            field = condition.get("field")
            operator = condition.get("operator")
            value = condition.get("value")
            
            actual = data.get(field)
            
            if operator == "equals" and actual != value:
                return False
            elif operator == "not_equals" and actual == value:
                return False
            elif operator == "greater_than" and (actual is None or actual <= value):
                return False
            elif operator == "less_than" and (actual is None or actual >= value):
                return False
            elif operator == "contains" and (actual is None or value not in str(actual)):
                return False
        
        return True
    
    def _resolve_recipient(
        self, 
        trigger, 
        data: Dict, 
        user_id: Optional[int]
    ) -> Optional[str]:
        """è§£ææ”¶ä»¶äºº"""
        from db.models.user import User
        
        if trigger.send_to_type == "trigger_user" and user_id:
            user = self.db.query(User).get(user_id)
            if user:
                # å¯¹äºå®‰å…¨ç›¸å…³é‚®ä»¶ï¼Œä¼˜å…ˆå‘é€åˆ°æ¢å¤é‚®ç®±
                if trigger.trigger_event in ["user.login_new_device", "user.password_changed"]:
                    return user.recovery_email or user.email
                return user.email
        
        elif trigger.send_to_type == "fixed_email":
            # å¯ä»¥ä» trigger.send_to_email æˆ– data ä¸­è·å–
            return trigger.send_to_email or data.get("notify_email")
        
        elif trigger.send_to_type == "admin":
            admin = self.db.query(User).filter(User.role == "admin").first()
            return admin.email if admin else None
        
        return None


# ä¾¿æ·å‡½æ•°
async def publish_event(db: Session, event_type: str, data: Dict, user_id: Optional[int] = None):
    """å‘å¸ƒäº‹ä»¶çš„ä¾¿æ·å‡½æ•°"""
    publisher = EventPublisher(db)
    await publisher.publish(event_type, data, user_id)
```

### 6.2 åœ¨ä¸šåŠ¡ä»£ç ä¸­ä½¿ç”¨

```python
# backend/api/auth.py

from core.events import publish_event

@router.post("/register")
async def register(user_data: UserCreate, db: Session = Depends(get_db)):
    # ... ç°æœ‰æ³¨å†Œé€»è¾‘ ...
    
    # å‘å¸ƒæ³¨å†ŒæˆåŠŸäº‹ä»¶
    await publish_event(
        db=db,
        event_type="user.register_success",
        data={
            "user_name": new_user.display_name or new_user.email.split('@')[0],
            "user_email": new_user.email,
            "register_time": datetime.now().strftime("%Y-%m-%d %H:%M:%S"),
            "login_url": f"https://{settings.BASE_DOMAIN}/login"
        },
        user_id=new_user.id
    )
    
    return {"message": "æ³¨å†ŒæˆåŠŸ", "user": new_user}


@router.post("/login")
async def login(credentials: LoginRequest, request: Request, db: Session = Depends(get_db)):
    # ... ç°æœ‰ç™»å½•é€»è¾‘ ...
    
    # æ£€æŸ¥æ˜¯å¦æ–°è®¾å¤‡
    is_new_device = check_new_device(user, request)
    
    if is_new_device:
        await publish_event(
            db=db,
            event_type="user.login_new_device",
            data={
                "user_name": user.display_name,
                "login_time": datetime.now().strftime("%Y-%m-%d %H:%M:%S"),
                "login_ip": request.client.host,
                "login_device": request.headers.get("User-Agent", "Unknown"),
                "login_location": get_location_by_ip(request.client.host)
            },
            user_id=user.id
        )
    
    return {"access_token": token, "token_type": "bearer"}
```

### 6.3 è§¦å‘å™¨ç®¡ç† API

```python
# backend/api/template_triggers.py

from fastapi import APIRouter, Depends, HTTPException
from sqlalchemy.orm import Session
from typing import List, Optional
from pydantic import BaseModel

router = APIRouter()

class TriggerConfig(BaseModel):
    template_code: str
    trigger_type: str  # system_event / scheduled / manual
    trigger_event: Optional[str] = None
    trigger_config: Optional[dict] = {}
    conditions: Optional[List[dict]] = []
    send_to_type: str = "trigger_user"
    send_to_email: Optional[str] = None
    cooldown_hours: int = 0
    is_enabled: bool = True


@router.get("/events")
def get_available_events(current_user = Depends(get_current_admin_user)):
    """è·å–å¯ç”¨çš„ç³»ç»Ÿäº‹ä»¶åˆ—è¡¨"""
    return {
        "events": SYSTEM_EVENTS,
        "categories": ["user", "email", "drive", "admin"]
    }


@router.get("/templates/{template_code}/trigger")
def get_template_trigger(
    template_code: str,
    db: Session = Depends(get_db),
    current_user = Depends(get_current_admin_user)
):
    """è·å–æ¨¡æ¿çš„è§¦å‘é…ç½®"""
    trigger = db.query(TemplateTrigger).filter(
        TemplateTrigger.template_code == template_code
    ).first()
    
    if not trigger:
        return {"configured": False}
    
    return {
        "configured": True,
        "trigger": trigger
    }


@router.put("/templates/{template_code}/trigger")
def update_template_trigger(
    template_code: str,
    config: TriggerConfig,
    db: Session = Depends(get_db),
    current_user = Depends(get_current_admin_user)
):
    """æ›´æ–°æ¨¡æ¿çš„è§¦å‘é…ç½®"""
    # æ£€æŸ¥æ¨¡æ¿æ˜¯å¦å­˜åœ¨
    template = db.query(SystemEmailTemplate).filter(
        SystemEmailTemplate.code == template_code
    ).first()
    
    if not template:
        raise HTTPException(status_code=404, detail="æ¨¡æ¿ä¸å­˜åœ¨")
    
    # æŸ¥æ‰¾æˆ–åˆ›å»ºè§¦å‘å™¨
    trigger = db.query(TemplateTrigger).filter(
        TemplateTrigger.template_code == template_code
    ).first()
    
    if not trigger:
        trigger = TemplateTrigger(template_code=template_code)
        db.add(trigger)
    
    # æ›´æ–°é…ç½®
    trigger.trigger_type = config.trigger_type
    trigger.trigger_event = config.trigger_event
    trigger.trigger_config = config.trigger_config
    trigger.conditions = config.conditions
    trigger.send_to_type = config.send_to_type
    trigger.send_to_email = config.send_to_email
    trigger.cooldown_hours = config.cooldown_hours
    trigger.is_enabled = config.is_enabled
    
    db.commit()
    
    return {"success": True, "trigger": trigger}


@router.get("/logs")
def get_trigger_logs(
    template_code: Optional[str] = None,
    status: Optional[str] = None,
    page: int = 1,
    page_size: int = 20,
    db: Session = Depends(get_db),
    current_user = Depends(get_current_admin_user)
):
    """è·å–è§¦å‘æ—¥å¿—"""
    query = db.query(TemplateTriggerLog)
    
    if template_code:
        query = query.filter(TemplateTriggerLog.template_code == template_code)
    if status:
        query = query.filter(TemplateTriggerLog.status == status)
    
    total = query.count()
    logs = query.order_by(TemplateTriggerLog.triggered_at.desc())\
        .offset((page - 1) * page_size)\
        .limit(page_size)\
        .all()
    
    return {
        "items": logs,
        "total": total,
        "page": page,
        "page_size": page_size
    }
```

---

## ä¸ƒã€å®ç°è®¡åˆ’ï¼ˆTodo Listï¼‰

### ç¬¬ä¸€é˜¶æ®µï¼šåŸºç¡€è®¾æ–½

- [ ] åˆ›å»º `template_triggers` è¡¨è¿ç§»
- [ ] åˆ›å»º `template_trigger_logs` è¡¨è¿ç§»
- [ ] å®ç° `EventPublisher` äº‹ä»¶å‘å¸ƒå™¨
- [ ] å®ç°è§¦å‘å™¨ç®¡ç† API
- [ ] åˆå§‹åŒ–é»˜è®¤è§¦å‘é…ç½®æ•°æ®

### ç¬¬äºŒé˜¶æ®µï¼šä¸šåŠ¡é›†æˆ

- [ ] åœ¨æ³¨å†ŒæˆåŠŸå¤„å‘å¸ƒ `user.register_success` äº‹ä»¶
- [ ] åœ¨ç™»å½•å¤„æ£€æµ‹æ–°è®¾å¤‡å¹¶å‘å¸ƒ `user.login_new_device` äº‹ä»¶
- [ ] åœ¨ä¿®æ”¹å¯†ç å¤„å‘å¸ƒ `user.password_changed` äº‹ä»¶
- [ ] åœ¨åˆ›å»ºåˆ†äº«å¤„å‘å¸ƒ `drive.file_shared` äº‹ä»¶
- [ ] åœ¨åˆ›å»ºé‚€è¯·å¤„å‘å¸ƒ `admin.invite_created` äº‹ä»¶

### ç¬¬ä¸‰é˜¶æ®µï¼šå‰ç«¯ç•Œé¢

- [ ] åœ¨ EmailTemplates.vue æ·»åŠ è§¦å‘çŠ¶æ€æ˜¾ç¤º
- [ ] åˆ›å»º TriggerConfigModal.vue è§¦å‘é…ç½®å¼¹çª—
- [ ] å®ç°ç³»ç»Ÿäº‹ä»¶é€‰æ‹©å™¨ç»„ä»¶
- [ ] å®ç°æ¡ä»¶é…ç½®ç»„ä»¶
- [ ] æ·»åŠ è§¦å‘æ—¥å¿—æŸ¥çœ‹åŠŸèƒ½

### ç¬¬å››é˜¶æ®µï¼šComposeModal é›†æˆ

- [ ] è·å–ç”¨æˆ·å¯ç”¨çš„æ‰‹åŠ¨è§¦å‘æ¨¡æ¿åˆ—è¡¨
- [ ] åˆ›å»º TemplateSelector.vue æ¨¡æ¿é€‰æ‹©ç»„ä»¶
- [ ] åˆ›å»º TemplateVariableForm.vue å˜é‡å¡«å†™ç»„ä»¶
- [ ] åœ¨ ComposeModal ä¸­é›†æˆæ¨¡æ¿é€‰æ‹©åŠŸèƒ½

### ç¬¬äº”é˜¶æ®µï¼šå®šæ—¶ä»»åŠ¡

- [ ] é›†æˆ APScheduler æˆ– Celery
- [ ] å®ç°å­˜å‚¨ç©ºé—´å®šæ—¶æ£€æŸ¥ä»»åŠ¡
- [ ] å®ç°è§¦å‘å™¨å®šæ—¶æ‰§è¡Œé€»è¾‘

---

## å…«ã€æ€»ç»“

æœ¬æ–¹æ¡ˆå®Œæ•´è§£å†³äº†ä»¥ä¸‹é—®é¢˜ï¼š

1. **è§¦å‘æ¡ä»¶åœ¨å“ªé‡Œè®¾ç½®**ï¼šåœ¨æ¨¡æ¿ç®¡ç†é¡µé¢ç‚¹å‡»"âš™ï¸ è§¦å‘è®¾ç½®"
2. **ä»€ä¹ˆæƒ…å†µä¸‹ä¼šè§¦å‘**ï¼šæ˜ç¡®å®šä¹‰äº†æ‰€æœ‰ç³»ç»Ÿäº‹ä»¶ï¼Œå¯è§†åŒ–é€‰æ‹©
3. **éå¼€å‘äººå‘˜å¦‚ä½•ä½¿ç”¨**ï¼š
   - ç®¡ç†å‘˜åœ¨ç•Œé¢é…ç½®è§¦å‘æ¡ä»¶
   - ä¸šåŠ¡äººå‘˜åœ¨ ComposeModal é€‰æ‹©æ¨¡æ¿å‘é€
4. **ä¸ç°æœ‰ç³»ç»Ÿçš„å…³ç³»**ï¼š
   - å¤ç”¨ç°æœ‰çš„é‚®ä»¶æ¨¡æ¿
   - ä¸è‡ªåŠ¨åŒ–è§„åˆ™å¼•æ“äº’è¡¥

å®æ–½åï¼Œæ•´ä¸ªé‚®ä»¶è‡ªåŠ¨åŒ–ç³»ç»Ÿå°†å…·å¤‡ï¼š
- âœ… å¯è§†åŒ–é…ç½®è§¦å‘æ¡ä»¶
- âœ… æ˜ç¡®çš„äº‹ä»¶åˆ—è¡¨
- âœ… çµæ´»çš„å‘é€ç›®æ ‡è®¾ç½®
- âœ… å®Œå–„çš„æ—¥å¿—è®°å½•
- âœ… ä¸šåŠ¡äººå‘˜å¯æ‰‹åŠ¨ä½¿ç”¨æ¨¡æ¿