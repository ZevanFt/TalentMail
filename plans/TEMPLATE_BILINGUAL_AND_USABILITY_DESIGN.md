# TalentMail é‚®ä»¶æ¨¡æ¿ç³»ç»Ÿä¼˜åŒ–è®¾è®¡æ–¹æ¡ˆ

## ä¸€ã€èƒŒæ™¯ä¸ç›®æ ‡

### 1.1 å½“å‰çŠ¶æ€åˆ†æ

**å·²æœ‰ä¼˜åŠ¿ï¼š**
- å˜é‡ç»“æ„å·²æ”¯æŒåŒè¯­ï¼š`key`ï¼ˆè‹±æ–‡å˜é‡åï¼‰+ `label`ï¼ˆä¸­æ–‡æ˜¾ç¤ºåç§°ï¼‰
- æ¨¡æ¿å…ƒæ•°æ®å®šä¹‰å®Œå–„ï¼šåŒ…å« `trigger_description`ï¼ˆè§¦å‘æ—¶æœºè¯´æ˜ï¼‰
- å…¨å±€å˜é‡æ”¯æŒä¸‰ç§ç±»å‹ï¼š`static`ã€`dynamic`ã€`config`

**å­˜åœ¨é—®é¢˜ï¼š**
1. æ¨¡æ¿åŠŸèƒ½ä»…é¢å‘ç®¡ç†å‘˜ï¼ˆåœ¨è®¾ç½®é¡µé¢ â†’ é‚®ä»¶æ¨¡æ¿ï¼‰
2. æ™®é€šç”¨æˆ·ï¼ˆå¦‚è´¢åŠ¡ï¼‰æ— æ³•ä½¿ç”¨é¢„è®¾æ¨¡æ¿å‘é€é‚®ä»¶
3. ComposeModal æ˜¯çº¯æ‰‹åŠ¨è¾“å…¥ï¼Œæ²¡æœ‰æ¨¡æ¿é€‰æ‹©åŠŸèƒ½
4. å‰ç«¯å˜é‡å±•ç¤ºæœªå……åˆ†åˆ©ç”¨ `label` ä¸­æ–‡åç§°

### 1.2 è®¾è®¡ç›®æ ‡

1. **è®©éå¼€å‘äººå‘˜èƒ½æ–¹ä¾¿ä½¿ç”¨é¢„è®¾æ¨¡æ¿å‘é€é‚®ä»¶**
   - è´¢åŠ¡äººå‘˜å¯ä»¥é€‰æ‹©"å‘ç¥¨é€šçŸ¥"æ¨¡æ¿ï¼Œåªéœ€å¡«å†™å˜é‡å€¼å³å¯å‘é€
   - HR å¯ä»¥é€‰æ‹©"å…¥èŒæ¬¢è¿"æ¨¡æ¿å‘é€ç»™æ–°å‘˜å·¥
   
2. **å¢å¼ºå˜é‡çš„å¯ç†è§£æ€§**
   - åœ¨æ‰€æœ‰ç•Œé¢ä¸­æ˜¾ç¤ºä¸­æ–‡ `label`
   - å˜é‡è¾“å…¥æ—¶æä¾›ç¤ºä¾‹å’Œè¯´æ˜

3. **ä¿æŒç³»ç»Ÿæ¨¡æ¿ä¸ç”¨æˆ·æ¨¡æ¿çš„åˆ†ç¦»**
   - ç³»ç»Ÿæ¨¡æ¿ï¼šéªŒè¯ç ã€å¯†ç é‡ç½®ç­‰ï¼ˆè‡ªåŠ¨è§¦å‘ï¼Œç”¨æˆ·ä¸èƒ½æ‰‹åŠ¨å‘é€ï¼‰
   - ä¸šåŠ¡æ¨¡æ¿ï¼šè´¢åŠ¡é€šçŸ¥ã€HR é€šçŸ¥ç­‰ï¼ˆç”¨æˆ·å¯æ‰‹åŠ¨ä½¿ç”¨ï¼‰

---

## äºŒã€æ•°æ®ç»“æ„è®¾è®¡

### 2.1 ç°æœ‰å˜é‡ç»“æ„ï¼ˆä¿æŒä¸å˜ï¼‰

```typescript
// æ¨¡æ¿å˜é‡å®šä¹‰
interface TemplateVariable {
  key: string       // è‹±æ–‡å˜é‡åï¼ˆç”¨äºæ¸²æŸ“å¼•æ“ï¼‰ï¼Œå¦‚ "invoice_number"
  label: string     // ä¸­æ–‡æ˜¾ç¤ºåç§°ï¼Œå¦‚ "å‘ç¥¨å·ç "
  type: string      // å˜é‡ç±»å‹ï¼šstring | number | url | datetime | email
  example: string   // ç¤ºä¾‹å€¼ï¼Œå¦‚ "FP-2024-001234"
  required: boolean // æ˜¯å¦å¿…å¡«
  description?: string // è¯¦ç»†è¯´æ˜ï¼ˆå¯é€‰ï¼‰
}
```

### 2.2 æ–°å¢ä¸šåŠ¡æ¨¡æ¿åˆ†ç±»

åœ¨ `category` å­—æ®µæ‰©å±•æ”¯æŒä»¥ä¸‹åˆ†ç±»ï¼š

```python
TEMPLATE_CATEGORIES = {
    # ç°æœ‰åˆ†ç±»ï¼ˆç³»ç»Ÿè‡ªåŠ¨è§¦å‘ï¼‰
    "auth": "è®¤è¯ç›¸å…³",           # éªŒè¯ç ã€å¯†ç é‡ç½®
    "notification": "ç³»ç»Ÿé€šçŸ¥",    # å­˜å‚¨è­¦å‘Šã€ç™»å½•æé†’
    "collaboration": "åä½œåˆ†äº«",   # æ–‡ä»¶åˆ†äº«ã€é‚€è¯·æ³¨å†Œ
    
    # æ–°å¢åˆ†ç±»ï¼ˆç”¨æˆ·å¯æ‰‹åŠ¨ä½¿ç”¨ï¼‰
    "finance": "è´¢åŠ¡é€šçŸ¥",         # å‘ç¥¨ã€ä»˜æ¬¾ã€æŠ¥é”€
    "hr": "äººäº‹é€šçŸ¥",             # å…¥èŒã€è€ƒå‹¤ã€å‡æœŸ
    "marketing": "è¥é”€æ¨å¹¿",       # ä¿ƒé”€ã€æ´»åŠ¨ã€æ–°å“
    "customer": "å®¢æˆ·æœåŠ¡",        # å·¥å•å›å¤ã€æ»¡æ„åº¦è°ƒæŸ¥
    "custom": "è‡ªå®šä¹‰æ¨¡æ¿",        # ç”¨æˆ·è‡ªå·±åˆ›å»ºçš„æ¨¡æ¿
}
```

### 2.3 æ¨¡æ¿å…ƒæ•°æ®æ‰©å±•

åœ¨ `TemplateMetadata` è¡¨ä¸­æ–°å¢å­—æ®µï¼š

```python
class TemplateMetadata(Base):
    # ... ç°æœ‰å­—æ®µ ...
    
    # æ–°å¢å­—æ®µ
    is_user_sendable = Column(Boolean, default=False, 
        comment="æ˜¯å¦å…è®¸ç”¨æˆ·æ‰‹åŠ¨ä½¿ç”¨æ­¤æ¨¡æ¿å‘é€é‚®ä»¶")
    allowed_roles = Column(JSON, default=list, 
        comment="å…è®¸ä½¿ç”¨çš„è§’è‰²åˆ—è¡¨ï¼Œç©ºè¡¨ç¤ºæ‰€æœ‰äºº")
    icon = Column(String(50), nullable=True, 
        comment="æ¨¡æ¿å›¾æ ‡ï¼ˆEmoji æˆ–å›¾æ ‡åç§°ï¼‰")
    usage_count = Column(Integer, default=0, 
        comment="ä½¿ç”¨æ¬¡æ•°ç»Ÿè®¡")
```

---

## ä¸‰ã€ä¸šåŠ¡æ¨¡æ¿ç¤ºä¾‹

### 3.1 è´¢åŠ¡æ¨¡æ¿ç¤ºä¾‹

```python
{
    "code": "invoice_notification",
    "name": "å‘ç¥¨å¼€å…·é€šçŸ¥",
    "category": "finance",
    "is_user_sendable": True,
    "allowed_roles": ["admin", "finance"],
    "icon": "ğŸ“„",
    "description": "é€šçŸ¥å®¢æˆ·å‘ç¥¨å·²å¼€å…·ï¼Œæä¾›å‘ç¥¨è¯¦æƒ…å’Œä¸‹è½½é“¾æ¥",
    "trigger_description": "è´¢åŠ¡äººå‘˜åœ¨å¼€å…·å‘ç¥¨åæ‰‹åŠ¨å‘é€",
    "variables": [
        {"key": "customer_name", "label": "å®¢æˆ·åç§°", "type": "string", "example": "å¼ ä¸‰", "required": True},
        {"key": "invoice_number", "label": "å‘ç¥¨å·ç ", "type": "string", "example": "FP-2024-001234", "required": True},
        {"key": "invoice_amount", "label": "å‘ç¥¨é‡‘é¢", "type": "number", "example": "12800.00", "required": True},
        {"key": "invoice_date", "label": "å¼€ç¥¨æ—¥æœŸ", "type": "datetime", "example": "2024-12-30", "required": True},
        {"key": "download_url", "label": "ä¸‹è½½é“¾æ¥", "type": "url", "example": "https://...", "required": True},
        {"key": "remark", "label": "å¤‡æ³¨", "type": "string", "example": "è¯·æŸ¥æ”¶", "required": False}
    ],
    "default_subject": "æ‚¨çš„å‘ç¥¨å·²å¼€å…· - {{invoice_number}}",
    "default_body_html": """
<div style="font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto; padding: 20px;">
    <h2 style="color: #059669;">å‘ç¥¨å¼€å…·é€šçŸ¥</h2>
    <p>å°Šæ•¬çš„ {{customer_name}}ï¼Œæ‚¨å¥½ï¼</p>
    <p>æ‚¨çš„å‘ç¥¨å·²å¼€å…·ï¼Œè¯¦æƒ…å¦‚ä¸‹ï¼š</p>
    <table style="width: 100%; border-collapse: collapse; margin: 20px 0;">
        <tr style="background-color: #f3f4f6;">
            <td style="padding: 10px; border: 1px solid #e5e7eb;"><strong>å‘ç¥¨å·ç </strong></td>
            <td style="padding: 10px; border: 1px solid #e5e7eb;">{{invoice_number}}</td>
        </tr>
        <tr>
            <td style="padding: 10px; border: 1px solid #e5e7eb;"><strong>å¼€ç¥¨æ—¥æœŸ</strong></td>
            <td style="padding: 10px; border: 1px solid #e5e7eb;">{{invoice_date}}</td>
        </tr>
        <tr style="background-color: #f3f4f6;">
            <td style="padding: 10px; border: 1px solid #e5e7eb;"><strong>å‘ç¥¨é‡‘é¢</strong></td>
            <td style="padding: 10px; border: 1px solid #e5e7eb; color: #dc2626; font-weight: bold;">Â¥{{invoice_amount}}</td>
        </tr>
    </table>
    {{#if remark}}
    <p style="color: #6b7280;">å¤‡æ³¨ï¼š{{remark}}</p>
    {{/if}}
    <div style="text-align: center; margin: 30px 0;">
        <a href="{{download_url}}" style="background-color: #059669; color: white; padding: 12px 24px; text-decoration: none; border-radius: 6px; font-weight: bold;">ä¸‹è½½å‘ç¥¨</a>
    </div>
    <hr style="border: none; border-top: 1px solid #e5e7eb; margin: 20px 0;">
    <p style="color: #9ca3af; font-size: 12px;">å¦‚æœ‰ç–‘é—®ï¼Œè¯·è”ç³»è´¢åŠ¡éƒ¨é—¨ã€‚</p>
</div>
"""
}
```

### 3.2 HR æ¨¡æ¿ç¤ºä¾‹

```python
{
    "code": "onboarding_welcome",
    "name": "æ–°å‘˜å·¥å…¥èŒæ¬¢è¿",
    "category": "hr",
    "is_user_sendable": True,
    "allowed_roles": ["admin", "hr"],
    "icon": "ğŸ‰",
    "description": "æ¬¢è¿æ–°å‘˜å·¥å…¥èŒï¼Œæä¾›å…¥èŒæŒ‡å—å’Œå¿…è¦ä¿¡æ¯",
    "trigger_description": "HR åœ¨å‘˜å·¥å…¥èŒå½“å¤©æˆ–å‰ä¸€å¤©å‘é€",
    "variables": [
        {"key": "employee_name", "label": "å‘˜å·¥å§“å", "type": "string", "example": "ç‹å°æ˜", "required": True},
        {"key": "department", "label": "æ‰€å±éƒ¨é—¨", "type": "string", "example": "æŠ€æœ¯éƒ¨", "required": True},
        {"key": "onboarding_date", "label": "å…¥èŒæ—¥æœŸ", "type": "datetime", "example": "2025-01-02", "required": True},
        {"key": "manager_name", "label": "ç›´å±é¢†å¯¼", "type": "string", "example": "æç»ç†", "required": True},
        {"key": "manager_email", "label": "é¢†å¯¼é‚®ç®±", "type": "email", "example": "li.manager@company.com", "required": True},
        {"key": "seat_location", "label": "å·¥ä½ä½ç½®", "type": "string", "example": "AåŒº3æ’5å·", "required": False},
        {"key": "onboarding_guide_url", "label": "å…¥èŒæŒ‡å—é“¾æ¥", "type": "url", "example": "https://...", "required": False}
    ],
    "default_subject": "æ¬¢è¿åŠ å…¥æˆ‘ä»¬ï¼- {{employee_name}} å…¥èŒæŒ‡å—",
    "default_body_html": """
<div style="font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto; padding: 20px;">
    <h2 style="color: #3b82f6;">ğŸ‰ æ¬¢è¿åŠ å…¥å›¢é˜Ÿï¼</h2>
    <p>äº²çˆ±çš„ {{employee_name}}ï¼Œ</p>
    <p>æ¬¢è¿æ‚¨åŠ å…¥æˆ‘ä»¬çš„å¤§å®¶åº­ï¼æˆ‘ä»¬éå¸¸æœŸå¾…ä¸æ‚¨å…±äº‹ã€‚</p>
    
    <div style="background-color: #f3f4f6; padding: 20px; border-radius: 8px; margin: 20px 0;">
        <h3 style="margin-top: 0;">å…¥èŒä¿¡æ¯</h3>
        <ul style="list-style: none; padding: 0; margin: 0;">
            <li style="padding: 8px 0; border-bottom: 1px solid #e5e7eb;">ğŸ“… å…¥èŒæ—¥æœŸï¼š{{onboarding_date}}</li>
            <li style="padding: 8px 0; border-bottom: 1px solid #e5e7eb;">ğŸ¢ æ‰€å±éƒ¨é—¨ï¼š{{department}}</li>
            <li style="padding: 8px 0; border-bottom: 1px solid #e5e7eb;">ğŸ‘¤ ç›´å±é¢†å¯¼ï¼š{{manager_name}} ({{manager_email}})</li>
            {{#if seat_location}}
            <li style="padding: 8px 0;">ğŸ“ å·¥ä½ä½ç½®ï¼š{{seat_location}}</li>
            {{/if}}
        </ul>
    </div>
    
    {{#if onboarding_guide_url}}
    <div style="text-align: center; margin: 30px 0;">
        <a href="{{onboarding_guide_url}}" style="background-color: #3b82f6; color: white; padding: 12px 24px; text-decoration: none; border-radius: 6px; font-weight: bold;">æŸ¥çœ‹å…¥èŒæŒ‡å—</a>
    </div>
    {{/if}}
    
    <p>å…¥èŒå½“å¤©è¯·æºå¸¦èº«ä»½è¯ç­‰ç›¸å…³è¯ä»¶ï¼Œå‰å°ä¼šå¼•å¯¼æ‚¨å®Œæˆå…¥èŒæ‰‹ç»­ã€‚</p>
    <p>å¦‚æœ‰ä»»ä½•é—®é¢˜ï¼Œè¯·éšæ—¶è”ç³» HR æˆ–æ‚¨çš„ç›´å±é¢†å¯¼ã€‚</p>
    
    <hr style="border: none; border-top: 1px solid #e5e7eb; margin: 20px 0;">
    <p style="color: #9ca3af; font-size: 12px;">ç¥æ‚¨å·¥ä½œé¡ºåˆ©ï¼</p>
</div>
"""
}
```

---

## å››ã€å‰ç«¯ç•Œé¢è®¾è®¡

### 4.1 ComposeModal å¢åŠ "ä½¿ç”¨æ¨¡æ¿"åŠŸèƒ½

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æ–°é‚®ä»¶                                              [Ã—]    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  æ”¶ä»¶äºº: [                                    ] [æŠ„é€]      â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
â”‚  ä¸»é¢˜:   [                                              ]   â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ [ä½¿ç”¨æ¨¡æ¿ â–¼]                                        â”‚   â”‚
â”‚  â”‚                                                     â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚   â”‚
â”‚  â”‚  â”‚ ğŸ“„ è´¢åŠ¡é€šçŸ¥                                  â”‚   â”‚   â”‚
â”‚  â”‚  â”‚    å‘ç¥¨å¼€å…·é€šçŸ¥                              â”‚   â”‚   â”‚
â”‚  â”‚  â”‚    ä»˜æ¬¾åˆ°è´¦é€šçŸ¥                              â”‚   â”‚   â”‚
â”‚  â”‚  â”‚    æŠ¥é”€å®¡æ‰¹ç»“æœ                              â”‚   â”‚   â”‚
â”‚  â”‚  â”‚ ğŸ‰ äººäº‹é€šçŸ¥                                  â”‚   â”‚   â”‚
â”‚  â”‚  â”‚    æ–°å‘˜å·¥å…¥èŒæ¬¢è¿                            â”‚   â”‚   â”‚
â”‚  â”‚  â”‚    å‡æœŸå®¡æ‰¹ç»“æœ                              â”‚   â”‚   â”‚
â”‚  â”‚  â”‚ ğŸ“¢ è¥é”€æ¨å¹¿                                  â”‚   â”‚   â”‚
â”‚  â”‚  â”‚    æ–°å“å‘å¸ƒé€šçŸ¥                              â”‚   â”‚   â”‚
â”‚  â”‚  â”‚    æ´»åŠ¨é‚€è¯·                                  â”‚   â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚   â”‚
â”‚  â”‚                                                     â”‚   â”‚
â”‚  â”‚                                                     â”‚   â”‚
â”‚  â”‚                                                     â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  [é™„ä»¶ğŸ“] [è¿½è¸ªğŸ‘ï¸]                              [å‘é€ âœˆ]   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 4.2 é€‰æ‹©æ¨¡æ¿åçš„å˜é‡å¡«å†™ç•Œé¢

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æ–°é‚®ä»¶ - ä½¿ç”¨æ¨¡æ¿: å‘ç¥¨å¼€å…·é€šçŸ¥                     [Ã—]    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  æ”¶ä»¶äºº: [customer@example.com                  ] [æŠ„é€]    â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
â”‚  ä¸»é¢˜:   [æ‚¨çš„å‘ç¥¨å·²å¼€å…· - FP-2024-001234            ]      â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
â”‚                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ å¡«å†™æ¨¡æ¿å˜é‡ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                  â”‚
â”‚  â”‚                                       â”‚                  â”‚
â”‚  â”‚  å®¢æˆ·åç§° *                           â”‚                  â”‚
â”‚  â”‚  [å¼ ä¸‰                          ]     â”‚                  â”‚
â”‚  â”‚  ç¤ºä¾‹: å¼ ä¸‰                           â”‚                  â”‚
â”‚  â”‚                                       â”‚                  â”‚
â”‚  â”‚  å‘ç¥¨å·ç  *                           â”‚                  â”‚
â”‚  â”‚  [FP-2024-001234                ]     â”‚                  â”‚
â”‚  â”‚  ç¤ºä¾‹: FP-2024-001234                 â”‚                  â”‚
â”‚  â”‚                                       â”‚                  â”‚
â”‚  â”‚  å‘ç¥¨é‡‘é¢ *                           â”‚                  â”‚
â”‚  â”‚  [12800.00                      ]     â”‚                  â”‚
â”‚  â”‚  ç¤ºä¾‹: 12800.00                       â”‚                  â”‚
â”‚  â”‚                                       â”‚                  â”‚
â”‚  â”‚  å¼€ç¥¨æ—¥æœŸ *                           â”‚                  â”‚
â”‚  â”‚  [2024-12-30                    ] ğŸ“…  â”‚                  â”‚
â”‚  â”‚                                       â”‚                  â”‚
â”‚  â”‚  ä¸‹è½½é“¾æ¥ *                           â”‚                  â”‚
â”‚  â”‚  [https://drive.company.com/... ]     â”‚                  â”‚
â”‚  â”‚                                       â”‚                  â”‚
â”‚  â”‚  å¤‡æ³¨                                 â”‚                  â”‚
â”‚  â”‚  [è¯·æŸ¥æ”¶                        ]     â”‚                  â”‚
â”‚  â”‚                                       â”‚                  â”‚
â”‚  â”‚         [é¢„è§ˆæ•ˆæœ]  [æ¸…ç©ºæ¨¡æ¿]        â”‚                  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                  â”‚
â”‚                                                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  [é™„ä»¶ğŸ“] [è¿½è¸ªğŸ‘ï¸]                              [å‘é€ âœˆ]   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 4.3 æ¨¡æ¿ç®¡ç†ç•Œé¢ä¼˜åŒ–

åœ¨ç°æœ‰ [`EmailTemplates.vue`](frontend/app/components/settings/EmailTemplates.vue) åŸºç¡€ä¸Šï¼š

1. **å˜é‡æ˜¾ç¤ºä¼˜åŒ–**ï¼šå˜é‡ Hover æ—¶æ˜¾ç¤ºå®Œæ•´ä¿¡æ¯
   ```
   {{invoice_number}}
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ ğŸ“ å‘ç¥¨å·ç              â”‚
   â”‚ ç±»å‹: string            â”‚
   â”‚ ç¤ºä¾‹: FP-2024-001234    â”‚
   â”‚ âœ“ å¿…å¡«                  â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
   ```

2. **æ–°å¢"ç”¨æˆ·å¯å‘é€"æ ‡è¯†**
   ```html
   <span class="badge">ğŸ“® ç”¨æˆ·å¯ä½¿ç”¨</span>
   ```

3. **åˆ†ç±»ç­›é€‰å¢åŠ æ–°åˆ†ç±»**
   ```vue
   const categories = [
     { value: 'auth', label: 'è®¤è¯ç›¸å…³', icon: 'ğŸ”' },
     { value: 'notification', label: 'ç³»ç»Ÿé€šçŸ¥', icon: 'ğŸ””' },
     { value: 'collaboration', label: 'åä½œåˆ†äº«', icon: 'ğŸ¤' },
     { value: 'finance', label: 'è´¢åŠ¡é€šçŸ¥', icon: 'ğŸ“„' },
     { value: 'hr', label: 'äººäº‹é€šçŸ¥', icon: 'ğŸ‘¥' },
     { value: 'marketing', label: 'è¥é”€æ¨å¹¿', icon: 'ğŸ“¢' },
     { value: 'customer', label: 'å®¢æˆ·æœåŠ¡', icon: 'ğŸ’¬' },
     { value: 'custom', label: 'è‡ªå®šä¹‰', icon: 'âœï¸' },
   ]
   ```

---

## äº”ã€åç«¯ API è®¾è®¡

### 5.1 è·å–ç”¨æˆ·å¯ç”¨æ¨¡æ¿åˆ—è¡¨

```
GET /api/email-templates/sendable
```

**å“åº”ï¼š**
```json
{
  "templates": [
    {
      "code": "invoice_notification",
      "name": "å‘ç¥¨å¼€å…·é€šçŸ¥",
      "category": "finance",
      "icon": "ğŸ“„",
      "description": "é€šçŸ¥å®¢æˆ·å‘ç¥¨å·²å¼€å…·",
      "variables": [
        {"key": "customer_name", "label": "å®¢æˆ·åç§°", "type": "string", "required": true, "example": "å¼ ä¸‰"}
      ]
    }
  ],
  "categories": [
    {"value": "finance", "label": "è´¢åŠ¡é€šçŸ¥", "icon": "ğŸ“„"},
    {"value": "hr", "label": "äººäº‹é€šçŸ¥", "icon": "ğŸ‘¥"}
  ]
}
```

### 5.2 ä½¿ç”¨æ¨¡æ¿å‘é€é‚®ä»¶

```
POST /api/mail/send-with-template
```

**è¯·æ±‚ï¼š**
```json
{
  "template_code": "invoice_notification",
  "to": "customer@example.com",
  "cc": "",
  "variables": {
    "customer_name": "å¼ ä¸‰",
    "invoice_number": "FP-2024-001234",
    "invoice_amount": "12800.00",
    "invoice_date": "2024-12-30",
    "download_url": "https://...",
    "remark": "è¯·æŸ¥æ”¶"
  },
  "is_tracked": false
}
```

**å“åº”ï¼š**
```json
{
  "success": true,
  "message": "é‚®ä»¶å·²å‘é€",
  "email_id": 12345
}
```

### 5.3 æ¸²æŸ“æ¨¡æ¿é¢„è§ˆï¼ˆç”¨æˆ·ç«¯ï¼‰

```
POST /api/email-templates/{code}/render
```

**è¯·æ±‚ï¼š**
```json
{
  "variables": {
    "customer_name": "å¼ ä¸‰",
    "invoice_number": "FP-2024-001234"
  }
}
```

**å“åº”ï¼š**
```json
{
  "subject": "æ‚¨çš„å‘ç¥¨å·²å¼€å…· - FP-2024-001234",
  "body_html": "...",
  "body_text": "..."
}
```

---

## å…­ã€å®ç°è®¡åˆ’

### é˜¶æ®µä¸€ï¼šæ•°æ®ç»“æ„æ‰©å±•ï¼ˆæ•°æ®åº“è¿ç§»ï¼‰

- [ ] æ–°å¢ `TemplateMetadata` å­—æ®µï¼š`is_user_sendable`ã€`allowed_roles`ã€`icon`ã€`usage_count`
- [ ] åˆ›å»º Alembic è¿ç§»è„šæœ¬
- [ ] æ›´æ–° [`init_template_data.py`](backend/initial/init_template_data.py) æ·»åŠ ä¸šåŠ¡æ¨¡æ¿

### é˜¶æ®µäºŒï¼šåç«¯ API å®ç°

- [ ] å®ç° `GET /api/email-templates/sendable` - è·å–ç”¨æˆ·å¯å‘é€æ¨¡æ¿
- [ ] å®ç° `POST /api/mail/send-with-template` - ä½¿ç”¨æ¨¡æ¿å‘é€é‚®ä»¶
- [ ] å®ç° `POST /api/email-templates/{code}/render` - æ¸²æŸ“æ¨¡æ¿é¢„è§ˆ
- [ ] æ·»åŠ æƒé™æ ¡éªŒï¼ˆæ£€æŸ¥ç”¨æˆ·è§’è‰²æ˜¯å¦åœ¨ `allowed_roles` ä¸­ï¼‰

### é˜¶æ®µä¸‰ï¼šå‰ç«¯ç•Œé¢å®ç°

- [ ] åˆ›å»º [`TemplateSelector.vue`](frontend/app/components/email/TemplateSelector.vue) æ¨¡æ¿é€‰æ‹©ç»„ä»¶
- [ ] åˆ›å»º [`TemplateVariableForm.vue`](frontend/app/components/email/TemplateVariableForm.vue) å˜é‡å¡«å†™ç»„ä»¶
- [ ] ä¿®æ”¹ [`ComposeModal.vue`](frontend/app/components/email/ComposeModal.vue) é›†æˆæ¨¡æ¿åŠŸèƒ½
- [ ] ä¼˜åŒ– [`EmailTemplates.vue`](frontend/app/components/settings/EmailTemplates.vue) å˜é‡æ˜¾ç¤º

### é˜¶æ®µå››ï¼šä¸šåŠ¡æ¨¡æ¿æ•°æ®åˆå§‹åŒ–

- [ ] æ·»åŠ è´¢åŠ¡æ¨¡æ¿ï¼šå‘ç¥¨é€šçŸ¥ã€ä»˜æ¬¾é€šçŸ¥ã€æŠ¥é”€ç»“æœ
- [ ] æ·»åŠ  HR æ¨¡æ¿ï¼šå…¥èŒæ¬¢è¿ã€å‡æœŸå®¡æ‰¹ã€è€ƒå‹¤æé†’
- [ ] æ·»åŠ è¥é”€æ¨¡æ¿ï¼šæ–°å“å‘å¸ƒã€æ´»åŠ¨é‚€è¯·
- [ ] æ·»åŠ å®¢æœæ¨¡æ¿ï¼šå·¥å•å›å¤ã€æ»¡æ„åº¦è°ƒæŸ¥

---

## ä¸ƒã€æŠ€æœ¯ç»†èŠ‚

### 7.1 å˜é‡ç±»å‹ä¸è¾“å…¥æ§ä»¶æ˜ å°„

| å˜é‡ç±»å‹ | è¾“å…¥æ§ä»¶ | è¯´æ˜ |
|---------|---------|------|
| `string` | `<input type="text">` | æ™®é€šæ–‡æœ¬ |
| `number` | `<input type="number">` | æ•°å­—è¾“å…¥ |
| `email` | `<input type="email">` | é‚®ç®±æ ¼å¼æ ¡éªŒ |
| `url` | `<input type="url">` | URL æ ¼å¼æ ¡éªŒ |
| `datetime` | `<DateTimePicker>` | æ—¥æœŸæ—¶é—´é€‰æ‹©å™¨ |
| `date` | `<DatePicker>` | æ—¥æœŸé€‰æ‹©å™¨ |
| `textarea` | `<textarea>` | å¤šè¡Œæ–‡æœ¬ |

### 7.2 å˜é‡å€¼éªŒè¯

```typescript
const validateVariable = (variable: TemplateVariable, value: string): string | null => {
  // å¿…å¡«æ£€æŸ¥
  if (variable.required && !value.trim()) {
    return `${variable.label} æ˜¯å¿…å¡«é¡¹`
  }
  
  // ç±»å‹æ£€æŸ¥
  switch (variable.type) {
    case 'email':
      if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(value)) {
        return `${variable.label} æ ¼å¼ä¸æ­£ç¡®`
      }
      break
    case 'url':
      try { new URL(value) } catch { return `${variable.label} ä¸æ˜¯æœ‰æ•ˆçš„é“¾æ¥` }
      break
    case 'number':
      if (isNaN(Number(value))) {
        return `${variable.label} å¿…é¡»æ˜¯æ•°å­—`
      }
      break
  }
  
  return null // éªŒè¯é€šè¿‡
}
```

### 7.3 æƒé™æ§åˆ¶æµç¨‹å›¾

```mermaid
flowchart TD
    A[ç”¨æˆ·ç‚¹å‡»ä½¿ç”¨æ¨¡æ¿] --> B{ç”¨æˆ·å·²ç™»å½•?}
    B -->|å¦| C[è·³è½¬ç™»å½•é¡µ]
    B -->|æ˜¯| D[è·å–å¯ç”¨æ¨¡æ¿åˆ—è¡¨]
    D --> E{æ¨¡æ¿æœ‰ allowed_roles?}
    E -->|å¦| F[è¿”å›æ‰€æœ‰ is_user_sendable=true çš„æ¨¡æ¿]
    E -->|æ˜¯| G{ç”¨æˆ·è§’è‰²åœ¨åˆ—è¡¨ä¸­?}
    G -->|å¦| H[è¿‡æ»¤æ‰è¯¥æ¨¡æ¿]
    G -->|æ˜¯| I[åŒ…å«è¯¥æ¨¡æ¿]
    F --> J[è¿”å›æ¨¡æ¿åˆ—è¡¨ç»™å‰ç«¯]
    H --> J
    I --> J
```

---

## å…«ã€ç”¨æˆ·ä½“éªŒä¼˜åŒ–

### 8.1 æ¨¡æ¿ä½¿ç”¨æµç¨‹

1. **å‘ç°**ï¼šåœ¨æ’°å†™é‚®ä»¶æ—¶ï¼Œæ˜¾ç¤º"ä½¿ç”¨æ¨¡æ¿"æŒ‰é’®
2. **é€‰æ‹©**ï¼šæŒ‰åˆ†ç±»æµè§ˆï¼Œæ”¯æŒæœç´¢
3. **å¡«å†™**ï¼šæ¸…æ™°çš„å˜é‡è¡¨å•ï¼Œæ˜¾ç¤ºä¸­æ–‡æ ‡ç­¾å’Œç¤ºä¾‹
4. **é¢„è§ˆ**ï¼šå®æ—¶é¢„è§ˆæ¸²æŸ“ç»“æœ
5. **å‘é€**ï¼šä¸€é”®å‘é€ï¼Œå˜é‡è‡ªåŠ¨æ›¿æ¢

### 8.2 æ–°æ‰‹å¼•å¯¼

é¦–æ¬¡ä½¿ç”¨æ—¶æ˜¾ç¤ºæç¤ºï¼š
```
ğŸ’¡ æç¤ºï¼šæ‚¨å¯ä»¥ä½¿ç”¨é¢„è®¾æ¨¡æ¿å¿«é€Ÿå‘é€é‚®ä»¶
   ç‚¹å‡»"ä½¿ç”¨æ¨¡æ¿"é€‰æ‹©é€‚åˆçš„æ¨¡æ¿ï¼Œåªéœ€å¡«å†™å˜é‡å³å¯å‘é€ä¸“ä¸šé‚®ä»¶
```

### 8.3 å¸¸ç”¨æ¨¡æ¿å¿«æ·è®¿é—®

- æ˜¾ç¤ºæœ€è¿‘ä½¿ç”¨çš„ 3 ä¸ªæ¨¡æ¿
- æ”¯æŒ"æ”¶è—"æ¨¡æ¿åŠŸèƒ½

---

## ä¹ã€æ€»ç»“

æœ¬è®¾è®¡æ–¹æ¡ˆé€šè¿‡ä»¥ä¸‹æ–¹å¼å®ç°éå¼€å‘äººå‘˜ä½¿ç”¨é‚®ä»¶æ¨¡æ¿çš„ç›®æ ‡ï¼š

1. **åˆ©ç”¨ç°æœ‰åŒè¯­ç»“æ„**ï¼š`key` + `label` çš„è®¾è®¡å·²ç»æ”¯æŒåŒè¯­
2. **åŒºåˆ†ç³»ç»Ÿæ¨¡æ¿ä¸ä¸šåŠ¡æ¨¡æ¿**ï¼šé€šè¿‡ `is_user_sendable` æ§åˆ¶
3. **é›†æˆåˆ° ComposeModal**ï¼šç”¨æˆ·åœ¨æ’°å†™é‚®ä»¶æ—¶å¯ç›´æ¥é€‰æ‹©æ¨¡æ¿
4. **å‹å¥½çš„å˜é‡å¡«å†™ç•Œé¢**ï¼šæ˜¾ç¤ºä¸­æ–‡æ ‡ç­¾ã€ç¤ºä¾‹å€¼ã€ç±»å‹æ ¡éªŒ
5. **æƒé™æ§åˆ¶**ï¼šä¸åŒè§’è‰²çœ‹åˆ°ä¸åŒæ¨¡æ¿

å®æ–½åï¼Œè´¢åŠ¡äººå‘˜å¯ä»¥è½»æ¾å‘é€å‘ç¥¨é€šçŸ¥ï¼ŒHR å¯ä»¥å‘é€å…¥èŒæ¬¢è¿é‚®ä»¶ï¼Œæ— éœ€äº†è§£æŠ€æœ¯ç»†èŠ‚ã€‚