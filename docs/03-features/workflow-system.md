# 工作流系统文档

TalentMail 的工作流系统是一个强大的无代码自动化引擎，允许用户通过可视化拖拽的方式创建复杂的邮件处理流程。

## 🎯 系统概述

工作流系统基于事件驱动架构，支持：
- 📊 可视化流程设计
- 🔄 自动化任务执行
- 🎨 拖拽式节点编辑
- 📝 灵活的配置选项
- 📈 执行状态追踪

## 🏗️ 技术架构

### 前端技术栈
- **框架**: Vue 3 + Nuxt 3
- **可视化库**: Vue Flow
- **UI 组件**: Headless UI + Tailwind CSS
- **状态管理**: Pinia

### 后端技术栈
- **框架**: FastAPI
- **ORM**: SQLAlchemy
- **执行引擎**: 自研的 RuntimeEngine
- **任务调度**: 基于事件触发

## 📦 核心组件

### 1. 节点类型系统

系统提供了 34 种预定义节点类型，分为 7 大类：

#### 触发器节点 (Triggers)
- 📧 **邮件接收触发器** - 收到新邮件时触发
- ⏰ **定时触发器** - 按计划时间触发
- 🔘 **手动触发器** - 手动执行工作流
- 📅 **日期触发器** - 特定日期触发
- 🔗 **Webhook触发器** - 外部调用触发

#### 逻辑控制节点 (Logic)
- ❓ **条件判断** - If/Else 分支
- 🔀 **Switch分支** - 多路分支
- 🔁 **循环** - 批量处理
- ⏸️ **延迟** - 等待指定时间
- 🔄 **并行执行** - 同时执行多个分支

#### 邮件动作节点 (Email Actions)
- ✉️ **发送邮件** - 发送新邮件
- ↩️ **回复邮件** - 自动回复
- ➡️ **转发邮件** - 自动转发
- 📝 **创建草稿** - 保存为草稿
- 🗑️ **删除邮件** - 删除指定邮件

#### 邮件操作节点 (Email Operations)
- 📂 **移动到文件夹** - 整理邮件
- 🏷️ **添加标签** - 标记邮件
- ✅ **标记已读/未读** - 更改状态
- ⭐ **标记星标** - 重要邮件标记
- 🔍 **搜索邮件** - 查找特定邮件

#### 数据处理节点 (Data)
- 📋 **提取数据** - 从邮件提取信息
- 🔄 **数据转换** - 格式转换
- 💾 **保存到数据库** - 数据持久化
- 📊 **数据聚合** - 统计分析
- 🔗 **API调用** - 调用外部接口
- 📝 **生成报告** - 创建报表

#### 集成节点 (Integration)
- 📨 **发送到Webhook** - 推送到外部系统
- 💬 **发送通知** - 系统内通知
- 📱 **发送短信** - SMS 通知
- 💬 **发送到Slack** - Slack 集成
- 📊 **同步到CRM** - CRM 系统集成

#### 结束节点 (End)
- ✅ **成功结束** - 正常完成
- ❌ **失败结束** - 异常终止
- 🔚 **终止流程** - 强制结束

### 2. 工作流编辑器

#### 主要功能
- **拖拽添加节点** - 从左侧面板拖拽节点到画布
- **连接节点** - 拖拽连接点创建流程
- **配置节点** - 右侧面板配置节点参数
- **画布操作** - 缩放、平移、小地图导航
- **快捷键支持** - 删除、复制、粘贴等

#### 界面布局
```
┌─────────────┬─────────────────────────┬─────────────┐
│   节点库    │       画布区域          │  属性面板   │
│             │                         │             │
│ ▼ 触发器   │    [触发器] → [动作]   │  节点配置   │
│   • 邮件    │         ↓               │             │
│   • 定时    │    [条件判断]          │  参数设置   │
│             │      ↙    ↘            │             │
│ ▼ 动作     │  [发送]  [归档]         │  保存/发布  │
└─────────────┴─────────────────────────┴─────────────┘
```

### 3. 执行引擎

#### 执行流程
1. **触发检测** - 监听触发条件
2. **上下文初始化** - 准备执行环境
3. **节点执行** - 按流程顺序执行
4. **状态记录** - 记录执行状态
5. **结果处理** - 处理执行结果

#### 执行上下文
```python
{
    "workflow_id": "工作流ID",
    "execution_id": "执行ID",
    "trigger_data": {}, # 触发数据
    "variables": {},    # 流程变量
    "node_outputs": {}, # 节点输出
    "current_node": "", # 当前节点
    "status": "running" # 执行状态
}
```

## 🎨 系统工作流

系统预置了 3 个核心工作流：

### 1. 用户注册流程 (`user_registration`)
```
[注册触发] → [验证邮箱] → [创建账号] → [发送欢迎邮件] → [成功]
```

### 2. 密码重置流程 (`password_reset`)
```
[重置请求] → [验证用户] → [生成令牌] → [发送邮件] → [等待确认] → [更新密码]
```

### 3. 邮箱验证流程 (`email_verification`)
```
[验证请求] → [生成验证码] → [发送邮件] → [等待验证] → [激活账号]
```

## 📊 数据模型

### 核心表结构

#### `workflow` - 工作流定义
```sql
- id: UUID
- name: 名称
- description: 描述
- status: 状态 (draft/published)
- canvas_data: 画布数据 (JSON)
- created_at: 创建时间
- updated_at: 更新时间
```

#### `workflow_node` - 节点定义
```sql
- id: UUID
- workflow_id: 所属工作流
- node_type: 节点类型
- position: 位置坐标
- config: 配置参数 (JSON)
```

#### `workflow_execution` - 执行记录
```sql
- id: UUID
- workflow_id: 工作流ID
- trigger_type: 触发类型
- status: 执行状态
- started_at: 开始时间
- completed_at: 结束时间
- context: 执行上下文 (JSON)
```

## 🔧 配置示例

### 邮件自动分类工作流
```json
{
  "name": "邮件自动分类",
  "nodes": [
    {
      "type": "email_received",
      "config": {
        "folder": "inbox"
      }
    },
    {
      "type": "condition",
      "config": {
        "conditions": [
          {
            "field": "from",
            "operator": "contains",
            "value": "@important.com"
          }
        ]
      }
    },
    {
      "type": "move_to_folder",
      "config": {
        "folder": "重要邮件"
      }
    }
  ]
}
```

### 定时报告工作流
```json
{
  "name": "每周统计报告",
  "nodes": [
    {
      "type": "schedule",
      "config": {
        "cron": "0 9 * * 1"
      }
    },
    {
      "type": "search_emails",
      "config": {
        "timeRange": "last_week"
      }
    },
    {
      "type": "generate_report",
      "config": {
        "template": "weekly_summary"
      }
    },
    {
      "type": "send_email",
      "config": {
        "to": "manager@company.com",
        "subject": "周报"
      }
    }
  ]
}
```

## 🚀 使用指南

### 创建工作流
1. 进入"工作流"页面
2. 点击"创建工作流"
3. 输入名称和描述
4. 进入编辑器设计流程

### 设计流程
1. 从左侧拖拽节点到画布
2. 连接节点建立流程
3. 点击节点配置参数
4. 保存并发布工作流

### 监控执行
1. 查看"执行历史"
2. 点击查看详细日志
3. 分析执行性能
4. 调试失败的流程

## 🔍 最佳实践

1. **简化流程** - 保持工作流简洁明了
2. **错误处理** - 添加异常处理节点
3. **性能优化** - 避免过多的循环和分支
4. **测试验证** - 发布前充分测试
5. **文档记录** - 为复杂流程添加说明

## 🚧 当前限制

- 暂不支持并行执行（计划中）
- 单个工作流最多 50 个节点
- 执行超时时间 5 分钟
- 循环最大迭代 100 次

## 📈 未来规划

- [ ] 支持子流程调用
- [ ] 增加更多集成节点
- [ ] 支持自定义节点开发
- [ ] 工作流版本管理
- [ ] 性能监控仪表板

---

更新时间：2025-02-01