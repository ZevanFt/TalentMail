# TalentMail 架构设计

## 📐 系统架构概览

TalentMail 采用现代化的微服务架构，通过 Docker Compose 编排多个独立服务，实现高可用、可扩展的企业级邮件系统。

## 🏗️ 整体架构图

```
┌─────────────────────────────────────────────────────────────────┐
│                         用户浏览器                               │
└─────────────────────────┬───────────────────────────────────────┘
                          │ HTTPS
┌─────────────────────────┴───────────────────────────────────────┐
│                    Caddy (反向代理/SSL)                          │
│                         端口: 80, 443                            │
└────────────┬──────────────────────────────────┬─────────────────┘
             │                                  │
┌────────────┴────────────┐        ┌───────────┴──────────────────┐
│   Frontend (Nuxt.js)    │        │    Backend (FastAPI)         │
│      端口: 3000         │        │      端口: 8000              │
│                         │        │      LMTP: 24                │
└─────────────────────────┘        └────────────┬─────────────────┘
                                               │
                    ┌──────────────────────────┼─────────────────┐
                    │                          │                 │
        ┌───────────┴────────┐     ┌──────────┴──────┐  ┌───────┴──────┐
        │  PostgreSQL DB     │     │  Mailserver     │  │   Docker     │
        │    端口: 5432      │     │  SMTP: 25,587   │  │   Socket     │
        │                    │     │  IMAP: 143,993  │  │              │
        └────────────────────┘     └─────────────────┘  └──────────────┘
```

## 🔧 核心组件说明

### 1. **前端服务 (Frontend)**
- **技术栈**: Nuxt.js 4 + Vue.js 3 + TypeScript
- **职责**:
  - 用户界面渲染
  - 状态管理
  - API 请求处理
  - 实时通知（WebSocket）
- **特点**:
  - SSR 服务端渲染
  - PWA 支持
  - 响应式设计

### 2. **后端服务 (Backend)**
- **技术栈**: FastAPI + Python 3.12
- **职责**:
  - RESTful API 提供
  - 业务逻辑处理
  - 数据库操作
  - 邮件收发管理
  - LMTP 服务（接收邮件）
- **特点**:
  - 异步处理
  - 自动 API 文档
  - JWT 认证

### 3. **数据库 (PostgreSQL)**
- **版本**: PostgreSQL 15
- **职责**:
  - 用户数据存储
  - 邮件元数据管理
  - 系统配置保存
  - 工作流定义存储
- **特点**:
  - ACID 事务
  - JSON 支持
  - 全文搜索

### 4. **邮件服务器 (docker-mailserver)**
- **基础**: Postfix + Dovecot
- **职责**:
  - SMTP 邮件发送
  - IMAP 邮件接收
  - 邮件存储
  - 垃圾邮件过滤
- **集成**:
  - SQL 认证（与 PostgreSQL 集成）
  - Fail2ban 安全防护

### 5. **反向代理 (Caddy)**
- **职责**:
  - HTTPS 终端
  - 负载均衡
  - 静态资源服务
  - 自动 SSL 证书
- **特点**:
  - 自动 HTTPS
  - HTTP/2 支持
  - 简单配置

## 🔄 数据流设计

### 发送邮件流程
```
用户 → Frontend → Backend API → SMTP → Mailserver → 外部邮件服务器
```

### 接收邮件流程
```
外部邮件 → Mailserver (Port 25) → LMTP → Backend (Port 24) → Database → WebSocket → Frontend
```

### 认证流程
```
登录请求 → Backend → Database (验证) → JWT Token → Frontend (存储) → 后续请求携带 Token
```

## 🗄️ 数据存储架构

### 1. **关系型数据（PostgreSQL）**
- 用户信息
- 邮件元数据
- 文件夹结构
- 系统配置
- 工作流定义

### 2. **文件存储（本地卷）**
- 邮件原始内容（Mailserver）
- 附件文件（Backend uploads）
- 用户上传文件

### 3. **缓存层（计划中）**
- Redis 用于会话管理
- 邮件列表缓存
- API 响应缓存

## 🔒 安全架构

### 1. **网络安全**
- HTTPS 强制使用
- HSTS 头部设置
- 内部服务网络隔离

### 2. **应用安全**
- JWT Token 认证
- TOTP 两步验证
- 密码加密存储（bcrypt）
- CSRF 保护

### 3. **邮件安全**
- SPF/DKIM/DMARC 配置
- TLS 加密传输
- 垃圾邮件过滤
- 病毒扫描（计划中）

## 🚀 部署架构

### 开发环境
- Docker Compose 单机部署
- 自签名 SSL 证书
- 本地域名解析

### 生产环境
- Docker Compose 编排
- Let's Encrypt SSL
- 域名 DNS 配置
- 备份策略

### 扩展架构（未来）
- Kubernetes 部署
- 多实例负载均衡
- 分布式存储
- 高可用数据库

## 📊 性能考虑

### 1. **并发处理**
- FastAPI 异步处理
- 多 Worker 进程
- 连接池管理

### 2. **缓存策略**
- 静态资源 CDN
- API 响应缓存
- 数据库查询缓存

### 3. **优化措施**
- 邮件分页加载
- 附件延迟加载
- 索引优化

## 🔗 相关文档

- [数据库设计](./database-schema.md)
- [API 设计](./api-design.md)
- [部署指南](../01-getting-started/production.md)
- [开发指南](../04-development/README.md)

---

最后更新：2025-02-01